openapi: 3.0.3
info:
  title: SmartResponsor Tag API
  version: "1.3.0"

components:
  parameters:
    TenantHeader:
      name: X-Tenant-Id
      in: header
      required: true
      schema: { type: string }
  schemas:
    Error:
      type: object
      properties:
        code: { type: string }
    TagCreate:
      type: object
      properties:
        name: { type: string }
        slug: { type: string }
        locale: { type: string, default: "en" }
        weight: { type: integer, default: 0 }
      required: [name]
    Tag:
      type: object
      properties:
        id: { type: string }
        slug: { type: string }
        name: { type: string }
        locale: { type: string }
        weight: { type: integer }
        created_at: { type: string }
        updated_at: { type: string }
    TagPatch:
      type: object
      properties:
        name: { type: string }
        locale: { type: string }
        weight: { type: integer }
    EntityRef:
      type: object
      properties:
        entityType: { type: string, pattern: '^[a-z][a-z0-9_]*$', description: 'Logical object type for assignment. Validated by pattern; allowlist is configured at application layer.' }
        entityId: { type: string }
      required: [entityType, entityId]
    EntityRefCompat:
      oneOf:
        - $ref: '#/components/schemas/EntityRef'
        - type: object
          properties:
            entity_type: { type: string }
            entity_id: { type: string }
          required: [entity_type, entity_id]
    AssignBulkOperation:
      type: object
      properties:
        op: { type: string, enum: [assign, unassign] }
        tagId: { type: string }
        entityType: { type: string, pattern: '^[a-z][a-z0-9_]*$', description: 'Logical object type for assignment. Validated by pattern; allowlist is configured at application layer.' }
        entityId: { type: string }
        idem: { type: string }
      required: [op, tagId, entityType, entityId]
    AssignBulk:
      type: object
      properties:
        operations:
          type: array
          items: { $ref: '#/components/schemas/AssignBulkOperation' }
      required: [operations]
    AssignBulkToEntity:
      type: object
      properties:
        entityType: { type: string, pattern: '^[a-z][a-z0-9_]*$', description: 'Logical object type for assignment. Validated by pattern; allowlist is configured at application layer.' }
        entityId: { type: string }
        tagIds:
          type: array
          items: { type: string }
      required: [entityType, entityId, tagIds]

paths:
  /tag:
    post:
      summary: Create a tag
      parameters: [ { $ref: '#/components/parameters/TenantHeader' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TagCreate' }
      responses:
        "201": { description: Created }
        "400": { description: Validation failed, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        "409": { description: Conflict, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /tag/{id}:
    get:
      summary: Get a tag
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: path, name: id, required: true, schema: { type: string } }
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Tag' } } } }
        "404": { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    patch:
      summary: Patch a tag
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: path, name: id, required: true, schema: { type: string } }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TagPatch' }
      responses:
        "200": { description: OK }
        "400": { description: Validation failed, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      summary: Delete a tag
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: path, name: id, required: true, schema: { type: string } }
      responses:
        "204": { description: Deleted }

  /tag/{id}/assign:
    post:
      summary: Assign a tag to an entity
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: path, name: id, required: true, schema: { type: string } }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EntityRefCompat' }
      responses:
        "200": { description: OK }

  /tag/{id}/unassign:
    post:
      summary: Unassign a tag from an entity
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: path, name: id, required: true, schema: { type: string } }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EntityRefCompat' }
      responses:
        "200": { description: OK }

  /tag/assign-bulk:
    post:
      summary: Bulk operations (assign/unassign) for multiple tag/entity pairs
      parameters: [ { $ref: '#/components/parameters/TenantHeader' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AssignBulk' }
      responses:
        "200": { description: OK }

  /tag/assignment/bulk:
    post:
      summary: Bulk assign multiple tags to a single entity
      parameters: [ { $ref: '#/components/parameters/TenantHeader' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AssignBulkToEntity' }
      responses:
        "200": { description: OK }

  /tag/assignments:
    get:
      summary: List tags assigned to an entity
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: query, name: entityType, schema: { type: string, pattern: '^[a-z][a-z0-9_]*$' }, required: true }
        - { in: query, name: entityId,   schema: { type: string }, required: true }
        - { in: query, name: limit,      schema: { type: integer, minimum: 1, default: 50 } }
      responses:
        "200": { description: OK }

  /tag/{id}/synonym:
    get:
      summary: List synonyms of a tag
      parameters: [{ in: path, name: id, required: true, schema: { type: string } }]
      responses: { "200": { description: OK } }
    post:
      summary: Add synonym to a tag
      parameters: [{ in: path, name: id, required: true, schema: { type: string } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: { label: { type: string } }
              required: [label]
      responses: { "200": { description: OK } }
    delete:
      summary: Remove synonym from a tag
      parameters: [{ in: path, name: id, required: true, schema: { type: string } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: { label: { type: string } }
              required: [label]
      responses: { "200": { description: OK } }

  /tag/redirect/{fromId}:
    get:
      summary: Resolve redirect (merged/split tag)
      parameters: [{ in: path, name: fromId, required: true, schema: { type: string } }]
      responses: { "200": { description: OK } }

  /tag/search:
    get:
      summary: Search tags by label/slug
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: query, name: q, schema: { type: string }, required: true }
        - { in: query, name: pageSize, schema: { type: integer, default: 20, minimum: 1, maximum: 200 } }
        - { in: query, name: pageToken, schema: { type: string } }
      responses: { "200": { description: OK } }

  /tag/suggest:
    get:
      summary: Suggest tags by prefix
      parameters:
        - { $ref: '#/components/parameters/TenantHeader' }
        - { in: query, name: q, schema: { type: string }, required: true }
        - { in: query, name: limit, schema: { type: integer, default: 10, minimum: 1, maximum: 50 } }
      responses: { "200": { description: OK } }

  /tag/_status:
    get:
      summary: Service status
      responses: { "200": { description: OK } }
